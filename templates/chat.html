{% extends "base.html" %}
{% block title %}Chat for {{ course_name }}{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0">Customize Timeline for {{ course_name }}</h1>
  <a href="{{ url_for('download_timeline', course_name=course_name) }}" class="btn-custom float-animation">
    <i class="fas fa-download me-2"></i>Download Timeline PDF
  </a>
</div>

<div class="card-custom glass mb-4">
  <div class="card-body">
    <h5 class="mb-3"><i class="fas fa-comments me-2"></i>Chat with Your AI Assistant</h5>
    <div class="chat-container glass-inner">
      {% for c in chats %}
      <div class="chat-message {% if c.user_id==current_user.id %}user-message{% else %}bot-message{% endif %}">
        <div class="message-header">
          <strong>{% if c.user_id==current_user.id %}You{% else %}LearnAI Assistant{% endif %}:</strong>
          <span class="message-time">{{ c.timestamp.strftime('%H:%M') if c.timestamp else '' }}</span>
        </div>
        <div class="message-content">{{ c.chat_query if c.chat_query else c.response }}</div>
      </div>
      {% else %}
      <div class="text-center text-muted py-4">
        <i class="fas fa-comment-dots fa-2x mb-2"></i>
        <p>Start a conversation to customize your learning timeline</p>
      </div>
      {% endfor %}
    </div>

    <form id="chatForm" class="mt-3">
      <div class="input-group glass-input">
        <input id="query" name="query" class="form-control"
          placeholder="Type command (e.g. 'shorten step 2 to 3 weeks')" autocomplete="off" />
        <button id="sendBtn" class="btn-custom">
          <i class="fas fa-paper-plane me-1"></i> Send
        </button>
      </div>
    </form>
  </div>
</div>

<div class="card-custom glass">
  <div class="card-body">
    <h5 class="mb-3"><i class="fas fa-road me-2"></i>Learning Timeline</h5>
    <div id="timeline" class="timeline-content glass-inner p-3">
      {{ timeline | safe }}
    </div>
  </div>
</div>

<style>
  .card-custom {
    border-radius: var(--border-radius);
    padding: 28px;
    transition: var(--transition);
    border: none;
    margin-bottom: 24px;
  }

  .card-custom:hover {
    transform: translateY(-5px);
  }

  .chat-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: var(--border-radius);
  }

  .chat-message {
    margin-bottom: 20px;
    padding: 16px;
    border-radius: 18px;
    max-width: 80%;
    word-break: break-word;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }

  .chat-message::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
  }

  .chat-message:hover::before {
    left: 100%;
  }

  .chat-message:hover {
    transform: translateY(-3px);
  }

  .user-message {
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    color: var(--white);
    margin-left: auto;
    border-bottom-right-radius: 4px;
    box-shadow: 0 6px 16px rgba(30, 58, 138, 0.25);
  }

  .bot-message {
    background: rgba(229, 231, 235, 0.7);
    backdrop-filter: blur(10px);
    color: var(--text-color);
    margin-right: auto;
    border-bottom-left-radius: 4px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
  }

  .message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  .message-time {
    font-size: 0.8rem;
    opacity: 0.8;
  }

  .message-content {
    line-height: 1.5;
  }

  .timeline-content {
    line-height: 1.6;
    border-radius: var(--border-radius);
  }

  .timeline-content ol {
    padding-left: 1.5rem;
  }

  .timeline-content li {
    margin-bottom: 12px;
    padding-left: 8px;
    transition: var(--transition);
    border-radius: 6px;
    padding: 8px 12px;
  }

  .timeline-content li:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: translateX(5px);
  }

  .timeline-content li::marker {
    color: var(--primary-light);
    font-weight: bold;
  }

  .glass-input {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 50px;
    padding: 4px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .form-control {
    border-radius: 50px;
    padding: 14px 20px;
    border: 2px solid transparent;
    transition: var(--transition);
    background: transparent;
  }

  .form-control:focus {
    border-color: rgba(59, 130, 246, 0.3);
    box-shadow: none;
    background: rgba(255, 255, 255, 0.9);
  }

  .btn-custom {
    display: inline-block;
    background: linear-gradient(135deg, var(--primary-light), var(--primary));
    color: var(--white);
    padding: 12px 24px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    box-shadow: var(--shadow-default);
    transition: var(--transition);
    cursor: pointer;
    user-select: none;
    border: none;
    text-transform: none;
    letter-spacing: normal;
    font-size: 1rem;
    position: relative;
    overflow: hidden;
    z-index: 1;
  }

  .btn-custom::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: 0.5s;
    z-index: -1;
  }

  .btn-custom:hover::before {
    left: 100%;
  }

  .btn-custom:hover {
    background: linear-gradient(135deg, var(--primary), var(--primary-light));
    box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
    transform: translateY(-3px);
    color: var(--white);
  }

  .glass-inner {
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  /* Animation for new messages */
  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.95);
    }

    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .chat-message:last-child {
    animation: messageAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Custom scrollbar for chat */
  .chat-container::-webkit-scrollbar {
    width: 8px;
  }

  .chat-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
  }

  .chat-container::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 10px;
  }

  .chat-container::-webkit-scrollbar-thumb:hover {
    background: var(--primary);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sendBtn = document.getElementById('sendBtn');
    const input = document.getElementById('query');
    const chatContainer = document.querySelector('.chat-container');
    const timelineOl = document.getElementById('timeline');
    const chatForm = document.getElementById('chatForm');

    // Auto-scroll to bottom of chat
    chatContainer.scrollTop = chatContainer.scrollHeight;

    function appendMessage(who, text) {
      const now = new Date();
      const timeString = now.getHours().toString().padStart(2, '0') + ':' +
        now.getMinutes().toString().padStart(2, '0');

      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message ' + (who === 'user' ? 'user-message' : 'bot-message');

      messageDiv.innerHTML = `
      <div class="message-header">
        <strong>${who === 'user' ? 'You' : 'LearnAI Assistant'}:</strong>
        <span class="message-time">${timeString}</span>
      </div>
      <div class="message-content">${text}</div>
    `;

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function sendMessage() {
      const message = input.value.trim();
      if (!message) return;

      sendBtn.disabled = true;
      const originalText = sendBtn.innerHTML;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending';

      appendMessage('user', message);

      fetch(window.location.pathname, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
      })
        .then(response => response.json())
        .then(data => {
          if (data && data.response) {
            appendMessage('bot', data.response);
            if (data.timeline && timelineOl) {
              timelineOl.innerHTML = '';
              if (typeof data.timeline === 'string') {
                timelineOl.innerHTML = data.timeline;
              } else if (Array.isArray(data.timeline)) {
                const ol = document.createElement('ol');
                data.timeline.forEach(function (step) {
                  const li = document.createElement('li');
                  li.innerHTML = step;
                  ol.appendChild(li);
                });
                timelineOl.appendChild(ol);
              }
            }
          } else if (data && data.error) {
            appendMessage('bot', 'Error: ' + data.error);
          } else {
            appendMessage('bot', 'No response from server.');
          }
        })
        .catch(err => {
          appendMessage('bot', 'Error: ' + (err.message || err));
        })
        .finally(() => {
          sendBtn.disabled = false;
          sendBtn.innerHTML = originalText;
          input.value = '';
          input.focus();
        });
    }

    sendBtn.addEventListener('click', function (e) {
      e.preventDefault();
      sendMessage();
    });

    chatForm.addEventListener('submit', function (e) {
      e.preventDefault();
      sendMessage();
    });

    // Allow pressing Enter to send message
    input.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });
  });
</script>
{% endblock %}